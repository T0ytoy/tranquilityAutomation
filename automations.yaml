- id: salon1
  alias: IM salon (gauche) et amp. salon off -> amp. salon on
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_livingroom_left
      click_type: single
  condition:
  - condition: state
    entity_id: light.AmpouleSalon
    state: 'off'
  action:
  - service: script.turn_on
    entity_id: script.turn_on_livingroom
#############################################################################
- id: salon2
  alias: IM salon (CGL) -> amp. salon faible
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_livingroom_left
      click_type: long
  condition: []
  action:
  - service: light.turn_on
    entity_id: light.AmpouleSalon
    data_template:
      brightness: 100
      kelvin: 3000
#############################################################################
- id: salon3
  alias: IM salon (gauche) et amp. salon on -> amp. salon off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_livingroom_left
      click_type: single
  condition:
  - condition: state
    entity_id: light.AmpouleSalon
    state: 'on'
  action:
  - service: script.turn_on
    entity_id: script.turn_off_livingroom
#############################################################################
- id: salon4
  alias: IM salon (droit) et amp. bureau off -> amp. bureau on
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_livingroom_right
      click_type: single
  condition:
  - condition: state
    entity_id: light.AmpouleBureau
    state: 'off'
  action:
  - service: script.turn_on
    entity_id: script.turn_on_desk
#############################################################################
- id: salon5
  alias: IM salon (CDL) -> amp. bureau faible
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_livingroom_right
      click_type: long
  condition: []
  action:
  - service: script.turn_on
    entity_id: script.turn_on_desk_weak
#############################################################################
- id: salon6
  alias: IM salon (droit) et amp. bureau on -> amp. bureau off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_livingroom_right
      click_type: single
  condition:
  - condition: state
    entity_id: light.AmpouleBureau
    state: 'on'
  action:
    service: script.turn_on
    entity_id: script.turn_off_desk
#############################################################################
- id: salon7
  alias: IM salon (CD) et salon off -> amp. salon & salon on
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_livingroom_both
      click_type: both
  condition:
  - condition: state
    entity_id: light.Lumiere_Salon
    state: 'off'
  action:
    - service: script.turn_on
      entity_id: script.turn_on_livingroom
    - service: script.turn_on
      entity_id: script.turn_on_desk
#############################################################################
- id: salon8
  alias: IM salon (CD) et salon on -> amp. salon & salon off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_livingroom_both
      click_type: both
  condition:
  - condition: state
    entity_id: light.Lumiere_Salon
    state: 'on'
  action:
    - service: script.turn_on
      entity_id: script.turn_off_livingroom
    - service: script.turn_on
      entity_id: script.turn_off_desk
#############################################################################
- id: salon9
  alias: IM salon (CDL) et amp. salon off -> amp. salon faible et bureau faible
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_livingroom_both
      click_type: long_both
  condition: []
  action:
  - service: script.turn_on
    entity_id: script.turn_on_livingroom_weak
  - service: script.turn_on
    entity_id: script.turn_on_desk_weak
#############################################################################
- id: salon10
  alias: IP salon (CS) -> amp. salon on /off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.portable_livingroom
      click_type: single
  condition: []
  action:
  - service: light.toggle
    entity_id: light.Lumiere_Salon
#############################################################################
- id: salon11
  alias: IP salon (CL) -> amp. salon faible
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.portable_livingroom
      click_type: long_click_press
  condition: []
  action:
  - service: light.turn_on
    entity_id: light.Lumiere_Salon
    data_template:
      brightness: 125
      kelvin: 3300
#############################################################################
- id: salon12
  alias: IP salon (CD) -> amp. salon forte
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.portable_livingroom
      click_type: double
  condition: []
  action:
  - service: light.turn_on
    entity_id: light.Lumiere_Salon
    data:
      brightness: 255
      kelvin: 4500
#############################################################################
- id: salon13
  alias: TV éteinte & lumières éteintes -> gateway jusqu'à allumage lumière
  trigger:
    platform: template 
    value_template: >
      {{ states.media_player.lg_oled55b7.attributes.entity_picture == null }}
  condition:
  - condition: state
    entity_id: light.AmpouleCuisine
    state: 'off'
  - condition: state
    entity_id: light.Lumiere_Salon
    state: 'off'
  - condition: numeric_state
    entity_id: sensor.illumination_gateway
    below: 200
  action:
  - service: light.turn_on
    entity_id: light.gateway
    data:
      rgb_color: [255, 120, 19]
      brightness: 255
  - wait_template: >
      {{ is_state('light.AmpouleSalon', 'on') 
        or is_state('light.AmpouleCuisine', 'on') 
        or is_state('light.AmpouleCouloir', 'on')
        or states.media_player.lg_oled55b7.attributes.entity_picture != null
      }}
  - service: light.turn_off
    entity_id: light.gateway
#############################################################################
- id: salon14
  alias: Température < 18°C -> notification
  trigger:
    platform: time_pattern
    minutes: '/15'
  condition:
  - condition: numeric_state
    entity_id: sensor.temperature_livingroom
    below: 18
  - condition: template
    value_template: >
      {{ (states.sensor.temperature_livingroom.state | float %0.1 )| round(1) <= 0.1 }}
  action:
  - service: notify.antoine_notification
    data_template:
      title: "Home Assistant"
      message: "Température salon : {{ states('sensor.temperature_livingroom') }}°C."
    data:
      data:
        tag: temperature-notification
#############################################################################
- id: cuisine1
  alias: IM cuisine (gauche) et amp. cuisine off -> amp. cuisine on
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_kitchen_left
      click_type: single
  condition:
  - condition: state
    entity_id: light.AmpouleCuisine
    state: 'off'
  - condition: state
    entity_id: light.gateway
    state: 'off'
  action:
    service: script.turn_on
    entity_id: script.turn_on_kitchen
#############################################################################
- id: cuisine2
  alias: IM cuisine (CGL) -> amp. cuisine faible
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_kitchen_left
      click_type: long
  condition: []
  action:
  - service: script.turn_on
    entity_id: script.turn_on_kitchen_weak
#############################################################################
- id: cuisine3
  alias: IM cuisine (gauche) et amp. cuisine on -> amp. cuisine off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_kitchen_left
      click_type: single
  condition:
  - condition: or
    conditions:
    - condition: state
      entity_id: light.AmpouleCuisine
      state: 'on'
    - condition: state
      entity_id: light.gateway
      state: 'on'
  action:
    service: script.turn_on
    entity_id: script.turn_off_kitchen
#############################################################################
- id: cuisine4
  alias: IM cuisine (droit) et salon off -> lumiere salon on
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_kitchen_right
      click_type: single
  condition:
  - condition: state
    entity_id: light.Lumiere_Salon
    state: 'off'
  action:
  - service: script.turn_on
    entity_id: script.turn_on_livingroom
  - service: script.turn_on
    entity_id: script.turn_on_desk
#############################################################################
- id: cuisine5
  alias: IM cuisine (CDL) -> salon faible
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_kitchen_right
      click_type: long
  condition: []
  action:
  - service: script.turn_on
    entity_id: script.turn_on_livingroom_weak
  - service: script.turn_on
    entity_id: script.turn_on_desk_weak
#############################################################################
- id: cuisine6
  alias: IM cuisine (droit) et salon on -> salon off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_kitchen_right
      click_type: single
  condition:
  - condition: state
    entity_id: light.Lumiere_Salon
    state: 'on'
  action:
  - service: script.turn_on
    entity_id: script.turn_off_livingroom
  - service: script.turn_on
    entity_id: script.turn_off_desk
#############################################################################
- id: cuisine7
  alias: IM cuisine (CD) et amp. cuisine off -> amp. cuisine & salon on
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_kitchen_both
      click_type: both
  condition:
  - condition: state
    entity_id: light.AmpouleCuisine
    state: 'off'
  action:
    - service: script.turn_on
      entity_id: script.turn_on_kitchen
    - service: script.turn_on
      entity_id: script.turn_on_livingroom
#############################################################################
- id: cuisine8
  alias: IM cuisine (CD) et amp. cuisine on -> amp. cuisine & salon off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_kitchen_both
      click_type: both
  condition:
  - condition: state
    entity_id: light.AmpouleCuisine
    state: 'on'
  action:
    - service: script.turn_on
      entity_id: script.turn_off_kitchen
    - service: script.turn_on
      entity_id: script.turn_off_livingroom
#############################################################################
- id: cuisine9
  alias: IM cuisine (CDL) et amp. cuisine off -> amp. cuisine faible et salon faible
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_kitchen_both
      click_type: long_both
  condition: []
  action:
  - service: script.turn_on
    entity_id: script.turn_on_kitchen_weak
  - service: script.turn_on
    entity_id: script.turn_on_livingroom_weak
#############################################################################
- id: chambre1
  alias: IM chambre (CS) et amp. chambre off -> Chambre on
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_bedroom
      click_type: single
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id: light.AmpouleChambre
      state: 'off'
    - condition: or
      conditions:
      - condition: state
        entity_id: light.LampeChevet
        state: 'off'
      - condition: state
        entity_id: light.LampeChevet
        state: 'unavailable'
  action:
    service: script.turn_on
    entity_id: script.turn_on_bedroom
#############################################################################
- id: chambre2
  alias: IM chambre (CL) -> Chambre on doux
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_bedroom
      click_type: long
  action:
    service: script.turn_on
    entity_id: script.turn_on_bedroom_weak
#############################################################################
- id: chambre3
  alias: IM chambre (CD) -> Chambre on fort
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_bedroom
      click_type: double
  action:
    service: script.turn_on
    entity_id: script.turn_on_bedroom_strong
#############################################################################
- id: chambre4
  alias: IM chambre (CS) et amp. chambre on -> Chambre off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_bedroom
      click_type: single
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: light.AmpouleChambre
        state: 'on'
      - condition: state
        entity_id: light.LampeChevet
        state: 'on'
  action:
    service: script.turn_on
    entity_id: script.turn_off_bedroom
##############################################################################
- id: chambre5
  alias: IP chambre (CS) et amp. chambre off -> Chambre on
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.portable_bedroom
      click_type: single
  condition:
  - condition: state
    entity_id: light.AmpouleChambre
    state: 'off'
  - condition: state
    entity_id: light.LampeChevet
    state: 'off'
  action:
    service: script.turn_on
    entity_id: script.turn_on_bedroom
#############################################################################
- id: chambre6
  alias: IP chambre (CL) -> Chambre on doux
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.portable_bedroom
      click_type: long_click_press
  action:
    service: script.turn_on
    entity_id: script.turn_on_bedroom_weak
#############################################################################
- id: chambre7
  alias: IP chambre (CD) -> Chambre on fort
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.portable_bedroom
      click_type: double
  action:
    service: script.turn_on
    entity_id: script.turn_on_bedroom_strong
#############################################################################
- id: chambre8
  alias: IP chambre (CS) et amp. chambre on -> Chambre off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.portable_bedroom
      click_type: single
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: light.AmpouleChambre
        state: 'on'
      - condition: state
        entity_id: light.LampeChevet
        state: 'on'
  action:
    service: script.turn_on
    entity_id: script.turn_off_bedroom
#############################################################################
- id: chambre9
  alias: Chauffage chambre on et porte ouverte -> Notification fermeture porte
  trigger:
    platform: time_pattern
    minutes: '/15'
  condition:
  # moins de 14°C à l'extérieur
  - condition: numeric_state
    entity_id: sensor.weather_temperature
    below: 14
  # Apres 23h & avant 1h
  - condition: template
    value_template: >      
      {% set hour = as_timestamp(now()) | timestamp_custom("%H") | float %}
      {{ hour >= 23 or hour < 1 }}
  # Porte chambre ouverte
  - condition: state
    entity_id: binary_sensor.door_sensor_bedroom
    state: 'on'
  action:
  - service: notify.antoine_anh_tv
    data_template:
      message: "Chauffage chambre démarré, fermer la porte !"
    data:
      data:
        tag: warming_bedroom-notification
#############################################################################
- id: chambre10
  alias: Limiteur batterie Antoine
  trigger:
    platform: template
    value_template: >
      {{ states.sensor.battery_level_antoine.state | int-1 > states.input_number.battery_charging_percentage_limit_antoine.state | int  }}
  action:
    service: switch.turn_off
    entity_id: switch.antoine_phone_smart_plug
#############################################################################
- id: chambre11
  alias: Limiteur batterie Antoine (off->on)
  trigger:
    platform: template
    value_template: >
      {{ states.sensor.battery_level_antoine.state | int+1 < states.input_number.battery_charging_percentage_limit_antoine.state | int  }}
  condition:
  - condition: state
    entity_id: device_tracker.smartphone_antoine
    state: 'home'
  action:
    service: switch.turn_on
    entity_id: switch.antoine_phone_smart_plug
#############################################################################
- id: chambre12
  alias: Limiteur Batterie Anh
  trigger:
    platform: template
    value_template: >
      {{ states.sensor.battery_level_anh.state | int-1 > states.input_number.battery_charging_percentage_limit_anh.state | int  }}
  action:
    service: switch.turn_off
    entity_id: switch.anh_phone_smart_plug
#############################################################################
- id: chambre13
  alias: Limiteur batterie Anh (off->on)
  trigger:
    platform: template
    value_template: >
      {{ states.sensor.battery_level_anh.state | int+1 < states.input_number.battery_charging_percentage_limit_anh.state | int  }}       
  condition:
  - condition: state
    entity_id: device_tracker.smartphone_anh
    state: 'home'
  action:
    service: switch.turn_on
    entity_id: switch.anh_phone_smart_plug
#############################################################################
- id: chambre14
  alias: Lecture média chromecast audio -> allumage enceintes
  trigger:
  - entity_id: media_player.chambre
    platform: state
    to: 'playing'
  action:
    service: switch.turn_on
    entity_id: switch.speakers_smart_plug
#############################################################################
- id: chambre15
  alias: Arret lecture média chromecast audio -> extinction enceintes
  trigger:
  - entity_id: media_player.chambre
    platform: state
    from: 'playing'
  action:
  - delay: 00:00:05
  - condition: template
    value_template: >
      {{ not is_state('media_player.chambre', 'playing') }}
  - service: switch.turn_off
    entity_id: switch.speakers_smart_plug
#############################################################################
- id: chambre16
  alias: Lecture média chromecast audio et extinction lumière chambre -> démarrage timer musique
  trigger:
  - entity_id: light.lumiere_chambre
    platform: state
    to: 'off'
  condition:
  - condition: state
    entity_id: media_player.chambre
    state: 'playing'
# handle this light going unavailable regularly
  - condition: state
    entity_id: light.lampechevet
    state: 'off'
  action:
    service: script.turn_on
    entity_id: script.speakers_timer_start
#############################################################################
- id: chambre17
  alias: Décompte extinction enceintes chambres
  trigger:
    platform: time_pattern
    minutes: '/1'
  condition:
  - condition: state
    entity_id: script.speakers_timer_start
    state: 'on'
  action:
  - service: input_number.set_value
    data_template:
      entity_id: input_number.speakers_turnoff_timer
      value: "{{ states.input_number.speakers_turnoff_timer.state | float-1 }}"
  - condition: numeric_state
    entity_id: input_number.speakers_turnoff_timer
    below: 1
  - service: input_number.set_value
    data_template:
      entity_id: input_number.speakers_turnoff_timer
      value: 90
  - service: media_player.turn_off
    entity_id: media_player.chambre
  - service: script.turn_off
    entity_id: script.speakers_timer_start
#############################################################################
- id: chambre18
  alias: Volume musique chambre diminue si lumière éteinte
  trigger:
    platform: time_pattern
    seconds: '/6'
  condition:
  - condition: state
    entity_id: media_player.chambre
    state: 'playing'
  - condition: state
    entity_id: light.lumiere_chambre
    state: 'off'
# handle this light going unavailable regularly
  - condition: state
    entity_id: light.lampechevet
    state: 'off' 
  action:
  - service: input_number.set_value
    data_template:
      entity_id: input_number.speakers_start_volume
      value: >
        {% if states.input_number.speakers_start_volume.state | float == 0 %}
          {{ state_attr("media_player.chambre", "volume_level") | float }}
        {% else %}
          {{ states.input_number.speakers_start_volume.state | float }}
        {% endif %}
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.chambre
      volume_level: >
        {% set step = (states.input_number.speakers_start_volume.state | float - states.input_number.speakers_target_volume.state | float/100) / (states.input_number.speakers_volume_change_duration.state | float * 10) %}
        {% set result = state_attr("media_player.chambre", "volume_level") | float - step %}
        {% if result < states.input_number.speakers_target_volume.state | float/100 %}
          {{ states.input_number.speakers_target_volume.state | float/100 }}
        {% else %}
          {{ result }}
        {% endif %}
  - condition: template
    value_template: >
      {{ state_attr("media_player.chambre", "volume_level") | float <=  states.input_number.speakers_target_volume.state | float/100}}
  - service: input_number.set_value
    data_template:
      entity_id: input_number.speakers_start_volume
      value: 0.0
#############################################################################
- id: couloir1
  alias: Détecteur mouv. couloir on -> amp. couloir on
  trigger:
    platform: event
    event_type: xiaomi_aqara.motion
    event_data:
      entity_id: binary_sensor.motion_sensor_hall
  condition: []
  action:
  - service: light.turn_on
    entity_id: light.AmpouleCouloir
    data_template:
      brightness: >
        {% if states.light.lumiere_salon.attributes.brightness is defined %}
          {{ states.light.lumiere_salon.attributes.brightness | multiply(0.5) | int }}
        {% else %}
          {% if now().hour >= 22 %}
            25
          {% elif now().hour < 9 %}
            15
          {% else %}
            180
          {% endif %}
        {% endif %}
      kelvin: >
        {% if states.light.lumiere_salon.attributes.brightness is defined %}
          {{ (1000000/states.light.lumiere_salon.attributes.color_temp) | int}}
        {% else %}
          {% if now().hour >= 22 %}
            3000
          {% elif now().hour < 9 %}
            2500
          {% else %}
            4500
          {% endif %}
        {% endif %}
#############################################################################
- id: couloir2
  alias: Détecteur mouv. couloir off -> amp. couloir off
  trigger:
    platform: state
    entity_id: binary_sensor.motion_sensor_hall
    to: 'off'
  action:
  - service: light.turn_off
    entity_id: light.AmpouleCouloir
#############################################################################
- id: couloir3
  alias: IM salon (CDDroit) ET couloir off -> amp. couloir on ET autom. couloir off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_livingroom_right
      click_type: double
  action:
  - service: light.turn_on
    entity_id: light.AmpouleCouloir
  - service: automation.turn_off
    entity_id: automation.detecteur_mouv_couloir_off_ampoule_couloir_off
#############################################################################
- id: couloir4
  alias: IM salon (CDDroit) ET couloir on -> amp. couloir off ET autom. couloir on
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_livingroom_right
      click_type: double
  condition:
  - condition: state
    entity_id: light.AmpouleCouloir
    state: 'on'
  action:
  - service: light.turn_off
    entity_id: light.AmpouleCouloir
  - service: automation.turn_on
    entity_id: automation.detecteur_mouv_couloir_off_ampoule_couloir_off
#############################################################################
- id: bathroom1
  alias: IM sdb (CS) et amp. sdb off -> sdb on
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_bathroom
      click_type: single
  condition:
  - condition: state
    entity_id: light.AmpouleSalleDeBain
    state: 'off'
  action:
    service: script.turn_on
    entity_id: script.turn_on_bathroom
#############################################################################
- id: bathroom2
  alias: IM sdb (CL) -> sdb faible
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_bathroom
      click_type: long
  condition: []
  action:
    service: script.turn_on
    entity_id: script.turn_on_bathroom_weak
#############################################################################
- id: bathroom3
  alias: IM sdb (CD) -> sdb max
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_bathroom
      click_type: double
  condition: []
  action:
    service: script.turn_on
    entity_id: script.turn_on_bathroom_strong
#############################################################################
- id: bathroom4
  alias: IM sdb (CS) et amp. sdb on -> sdb off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_bathroom
      click_type: single
  condition:
  - condition: state
    entity_id: light.AmpouleSalleDeBain
    state: 'on'
  action:
  - service: script.turn_on
    entity_id: script.turn_off_bathroom
#############################################################################
- id: toilets1
  alias: IM toilettes (CS) et amp. toilettes off -> toilettes on
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_toilets
      click_type: single
  condition:
  - condition: state
    entity_id: light.AmpouleToilettes
    state: 'off'
  action:
    service: script.turn_on
    entity_id: script.turn_on_toilets
#############################################################################
- id: toilets2
  alias: IM toilettes (CL) -> toilettes faible
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_toilets
      click_type: long
  condition: []
  action:
    service: script.turn_on
    entity_id: script.turn_on_toilets_weak
#############################################################################
- id: toilets3
  alias: IM toilettes (CD) -> toilettes max
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_toilets
      click_type: double
  condition: []
  action:
    service: script.turn_on
    entity_id: script.turn_on_toilets_strong
#############################################################################
- id: toilets4
  alias: IM toilettes (CS) et amp. toilettes on -> toilettes off
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.wall_toilets
      click_type: single
  condition:
  - condition: state
    entity_id: light.AmpouleToilettes
    state: 'on'
  action:
    service: light.turn_off
    entity_id: light.AmpouleToilettes
#############################################################################
- id: routine1
  alias: Routine réveil
  trigger:
    platform: time_pattern
    minutes: '/1'
  condition:
  - condition: state
    entity_id: group.all_lights
    state: 'off'
  - condition: template
    value_template: >
      {% set one_minute_before_wake_up = states.input_datetime.morning_routine_date_time.attributes.timestamp | int -(1*60) %} 
      {{ as_timestamp(now()) | timestamp_custom("%d%m%Y%H%M") == one_minute_before_wake_up | timestamp_custom("%d%m%Y%H%M", false)}}
  action:
  - service: light.turn_on
    entity_id: light.LampeChevet
    data:
      rgb_color: [255, 0, 0]
      brightness_pct: 1
  - delay: 00:01:00
  - service: light.turn_on
    entity_id: light.LampeChevet
    data:
      rgb_color: [255,100,0]
      brightness_pct: 25
      transition: 420
  - delay: 00:07:00
  - service: light.turn_on
    entity_id: light.LampeChevet
    data:
      rgb_color: [255,230,200]
      brightness_pct: 40
      transition: 240
  - delay: 00:04:00
  - service: light.turn_on
    entity_id: light.AmpouleChambre
    data:
      rgb_color: [255,230,200]
      brightness_pct: 10
      transition: 180
  - delay: 00:00:05
  - wait_template: >
      {{ is_state('binary_sensor.motion_sensor_hall', 'on') }}
  - delay: 00:00:01
  - service: light.turn_on
    entity_id: light.AmpouleToilettes
    data:
      brightness: 20
      kelvin: 3000
  - delay: 00:00:01
  - service: light.turn_on
    entity_id: light.AmpouleSalleDeBain
    data:
      brightness: 20
      kelvin: 3000
  - delay: 00:01:00
  - service: light.turn_on
    entity_id: light.AmpouleSalon
    data:
      brightness: 255
      kelvin: 5000
  - service: light.turn_on
    entity_id: light.AmpouleCuisine
    data:
      brightness: 255
      kelvin: 5000
# --------------------------------------
# calculer l'écart en minutes entre l'heure actuelle et l'heure de départ au travail paramétrée. 
# Si ce temps est suffisamment faible, on est dans le cas d'un jour de travail et on continue sur la routine.
# --------------------------------------
  - condition: template
    value_template: >
      {% set departure_time_minutes = (states.input_datetime.home_departure_time.attributes.timestamp | timestamp_custom("%H", false) | int * 60 
        + states.input_datetime.home_departure_time.attributes.timestamp | timestamp_custom("%M", false) | int ) %}
      {% set now_minutes = (as_timestamp(now()) | timestamp_custom("%H") | int * 60 + (as_timestamp(now()) | timestamp_custom("%M") | int)) %}
      {{ departure_time_minutes - now_minutes < 60 and departure_time_minutes - now_minutes > 0 }}
# --------------------------------------
# attendre l'heure de départ au travail moins 4 minutes
# --------------------------------------
  - wait_template: >
      {% set four_minutes_before_departure_time = states.input_datetime.home_departure_time.attributes.timestamp | int -(4*60) %}
      {% set time_now = as_timestamp(strptime(states.sensor.date_time.state, '%Y-%m-%d, %H:%M'))| timestamp_custom("%H%M", false) %}
      {{ time_now  == four_minutes_before_departure_time | timestamp_custom("%H%M", false)}}
  - service: light.turn_on
    entity_id: light.gateway
    data:
      rgb_color: [255, 127, 0]
      brightness_pct: 60
  - delay: 00:01:00
  - service: light.turn_on
    entity_id: light.gateway
    data:
      rgb_color: [255, 84, 0]
      brightness_pct: 75
  - delay: 00:01:00
  - service: light.turn_on
    entity_id: light.gateway
    data:
      rgb_color: [255, 42, 0]
      brightness_pct: 90
  - delay: 00:01:00
  - service: light.turn_on
    entity_id: light.gateway
    data:
      rgb_color: [255, 0, 0]
      brightness_pct: 100
  - delay: 00:06:00
  - service: light.turn_off
    entity_id: group.all_lights
#############################################################################
- id: 'routine2'
  alias: Absence Antoine -> chargeur off
  trigger:
  - entity_id: device_tracker.smartphone_antoine
    platform: state
    from: 'home'
    to: 'not_home'
    for: 00:10:00
  condition: []
  action:
    service: switch.turn_off
    entity_id: switch.antoine_phone_smart_plug
#############################################################################
- id: 'routine3'
  alias: Absence Anh -> chargeur off
  trigger:
  - entity_id: device_tracker.smartphone_anh
    platform: state
    from: 'home'
    to: 'not_home'
    for: 00:10:00
  condition: []
  action:
    service: switch.turn_off
    entity_id: switch.anh_phone_smart_plug
#############################################################################
- id: 'routine4'
  alias: Retour Antoine -> chargeur on
  trigger:
  - entity_id: device_tracker.smartphone_antoine
    platform: state
    from: 'not_home'
    to: 'home'
  condition:
    condition: template
    value_template: >
      {{ states.sensor.battery_level_antoine.state | int+1 < states.input_number.battery_charging_percentage_limit_antoine.state | int  }}
  action:
    service: switch.turn_on
    entity_id: switch.antoine_phone_smart_plug
#############################################################################
- id: 'routine5'
  alias: Retour Anh -> chargeur on
  trigger:
  - entity_id: device_tracker.smartphone_anh
    platform: state
    from: 'not_home'
    to: 'home'
  condition:
    condition: template
    value_template: >
      {{ states.sensor.battery_level_anh.state | int+1 < states.input_number.battery_charging_percentage_limit_anh.state | int  }}
  action:
    service: switch.turn_on
    entity_id: switch.anh_phone_smart_plug
#############################################################################
- id: 'camera1'
  alias: Absence + mouvement -> enregistrement caméra
  trigger:
  - entity_id: binary_sensor.camera_motion
    platform: state
    from: 'off'
    to: 'on'
  condition:
  - condition: state
    entity_id: group.admin_devices
    state: 'not_home'
  action:
  - service: script.turn_on
    entity_id: script.record_camera
  - service: notify.antoine_notification
    data_template:
      title: "Home Assistant"
      message: "Mouvement détecté : caméra déclenchée"
#############################################################################
- id: 'camera2'
  alias: Départ appartement -> détecteur mouv. caméra on
  trigger:
  - entity_id: group.admin_devices
    platform: state
    from: 'home'
    to: 'not_home'
  condition: []
  action:
    service: ffmpeg.start
    entity_id: binary_sensor.camera_motion
#############################################################################
- id: 'camera3'
  alias: Retour appartement -> détecteur mouv. caméra off
  trigger:
  - entity_id: group.admin_devices
    platform: state
    from: 'not_home'
    to: 'home'
  condition: []
  action:
    service: ffmpeg.stop
    entity_id: binary_sensor.camera_motion
